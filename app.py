from flask import Flask, render_template, request, redirect, url_for, session, jsonify
import json
import os
import random
from datetime import datetime

app = Flask(__name__)
app.secret_key = 'al-khwarizmi-secret-2025'

# Add enumerate as a Jinja2 filter
app.jinja_env.globals['enumerate'] = enumerate

# โโโ Game Data โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CORRECT_SENTENCES = [
    "ุฐูุจุช ุฅูู ุงูุณูู.", "ูุฑุฃุช ุงููุชุงุจ ุงูุฌุฏูุฏ.", "ูุชุจุช ุงูุฑุณุงูุฉ ุงูุทูููุฉ.",
    "ุดุฑุจุช ุงูุนุตูุฑ ุงูุจุงุฑุฏ.", "ูุธูุช ุงูุบุฑูุฉ ุฌูุฏุงู.", "ูุนุจุช ุงููุฑุฉ ูุน ุงูุฃุตุฏูุงุก.",
    "ุฐูุจุช ุฅูู ุงููุฏุฑุณุฉ ุจุงูุฑุงู.", "ุฒุฑุช ุตุฏููู ุงููุฑูุถ.", "ุงุดุชุฑูุช ุงูููุงูู ุงูุทุงุฒุฌุฉ.",
    "ุญูุธุช ุงููุตูุฏุฉ ุงูุฌูููุฉ.", "ุณุงูุฑุช ุฅูู ุงูุจุญุฑ.", "ุฑุฃูุช ุงูููุธุฑ ุงูุฑุงุฆุน.",
    "ุณูุนุช ุงูุฃุบููุฉ ุงูุญุฒููุฉ.", "ุดุงูุฏุช ุงููููู ุงูููุชุน.", "ุฒุฑุนุช ุงูุฃุดุฌุงุฑ ุงููุจูุฑุฉ.",
    "ุจููุช ุงูุจูุช ุงูุตุบูุฑ.", "ุฑุณูุช ุงูููุญุฉ ุงููููุฉ.", "ุบูุช ุงูุฃุบููุฉ ุงููุทููุฉ.",
    "ุฑูุถุช ูู ุงูุญุฏููุฉ.", "ุณุจุญุช ูู ุงูุจุญุฑ.", "ุทุฑุช ูู ุงูุทุงุฆุฑุฉ.", "ูุดูุช ูู ุงูููุชุฒู.",
    "ุฌูุณุช ุนูู ุงูููุนุฏ.", "ูููุช ูู ุงูุทุงุจูุฑ.", "ุถุญูุช ูู ุงูููุจ.", "ุจููุช ูู ุงููุฑุญ.",
    "ุชุญุฏุซุช ุจุตุฑุงุญุฉ.", "ุณุงูุฑุช ุจุงููุทุงุฑ.", "ุนุฏุช ูุณุฑูุฑุงู.", "ุฌุฆุช ูุจูุฑุงู."
]

INCORRECT_SENTENCES = [
    "ุงูุทูุงุจ ูุฐูุจ ุฅูู ุงููุฏุฑุณุฉ.", "ุงููุนููุงุช ุชุดุฑุญ ุงูุฏุฑุณ.", "ูุฐุงู ุงูุทุงูุจ ูุฌุชูุฏ.",
    "ุงูุทุงูุจุงุช ูุชุจุช ุงููุงุฌุจ.", "ุงูุฃููุงุฏ ููุนุจ ูู ุงูุญุฏููุฉ.", "ุฑุฃูุช ุงููุนูููู.",
    "ูุฑุฑุช ุจุงูุทูุงุจ ุงููุฌุชูุฏูู.", "ูุฐูู ูุชุงุจ ูููุฏ.", "ูููุช ุงููุนูููู.",
    "ุณููุช ุนูู ุงูุฃุณุชุงุฐูู.", "ุงูุทุงูุจ ุงููุฌุชูุฏูู.", "ุงูุจูุช ุงูุฌูููุงุช.",
    "ูุฐุง ูุชุจ.", "ูุฐู ุฃููุงู.", "ุงูุทุงูุจุงู ุงููุฌุชูุฏ.", "ูุงู ุงูุทูุงุจ ูุฌุชูุฏ.",
    "ุฃุตุจุญ ุงูุฌู ุฌูููุฉ.", "ุตุงุฑ ุงููุงุก ุจุงุฑุฏุฉ.", "ุฃูุณู ุงูุทุงูุจ ูุชุนุจูู.",
    "ุฅู ุงูุทุงูุจ ูุฌุชูุฏูู.", "ูุฃู ุงูุจูุช ุฌูููุงุช.", "ููุช ุงูุฃููุงุฏ ููุนุจ.",
    "ุฃูุง ุฐูุจ ุฅูู ุงููุฏุฑุณุฉ.", "ูู ุฃูู ุงูุทุนุงู.", "ูู ูุชุจ ุงููุงุฌุจ.",
    "ุงุดุชุฑูุช ุฎูุณ ูุชุงุจ.", "ุฑุฃูุช ุซูุงุซ ุจูุงุช.", "ูู ุงููุตู ุนุดุฑ ุทุงูุจ.",
    "ูุชู ุฃูุช ุชุฐูุจุ", "ุฃูู ูู ุจูุชูุ", "ููู ุฃูุช ุญุงููุ"
]

QUESTIONS = {
    1: [
        {"id": 1, "type": "multiple_choice", "points": 10,
         "question": "ูุง ุงููุงุนู ูู ุงูุฌููุฉ: 'ูุฑุฃ ุงูุทุงูุจู ุงููุชุงุจู'ุ",
         "sentence": "ูุฑุฃ ุงูุทุงูุจู ุงููุชุงุจู", "correct": 0,
         "options": ["ุงูุทุงูุจู", "ุงููุชุงุจู", "ูุฑุฃ", "ุงููุฏุฑุณุฉ"],
         "explanation": "ุงููุงุนู ูู ุงูุทุงูุจู ูุฃูู ูู ูุงู ุจูุนู ุงููุฑุงุกุฉ ููู ูุฑููุน ุจุงูุถูุฉ",
         "hint": "ุงููุงุนู ูู ูู ูุงู ุจุงููุนู"},
        {"id": 2, "type": "multiple_choice", "points": 10,
         "question": "ูุง ุงูููุนูู ุจู ูู ุงูุฌููุฉ: 'ูุชุจุชู ุงูุชูููุฐุฉู ุงูุฏุฑุณู'ุ",
         "sentence": "ูุชุจุชู ุงูุชูููุฐุฉู ุงูุฏุฑุณู", "correct": 1,
         "options": ["ุงูุชูููุฐุฉู", "ุงูุฏุฑุณู", "ูุชุจุชู", "ุงูููู"],
         "explanation": "ุงูููุนูู ุจู ูู ุงูุฏุฑุณู ูุฃูู ูู ููุน ุนููู ูุนู ุงููุชุงุจุฉ ููู ููุตูุจ ุจุงููุชุญุฉ",
         "hint": "ุงูููุนูู ุจู ูู ูุง ููุน ุนููู ุงููุนู"},
        {"id": 3, "type": "correct_sentence", "points": 15,
         "question": "ุตุญุญ ุงูุฌููุฉ ุงูุชุงููุฉ: 'ุฐูุจุชู ุฅูู ุงููุฏุฑุณุฉู ุตุจุงุญุงู'",
         "sentence": "ุฐูุจุชู ุฅูู ุงููุฏุฑุณุฉู ุตุจุงุญุงู", "correct_answer": "ุงูุฌููุฉ ุตุญูุญุฉ",
         "explanation": "ุงูุฌููุฉ ุตุญูุญุฉ ุฅุนุฑุงุจูุงู",
         "hint": "ุฑุงุฌุน ุงูุถูุงุฆุฑ ุงููุชุตูุฉ"},
        {"id": 4, "type": "multiple_choice", "points": 10,
         "question": "ูุง ููุน ุงููููุฉ 'ูุฏุฑุณุฉ' ูู: 'ุฐูุจุช ุฅูู ุงููุฏุฑุณุฉู'ุ",
         "sentence": "ุฐูุจุช ุฅูู ุงููุฏุฑุณุฉู", "correct": 0,
         "options": ["ุงุณู ูุฌุฑูุฑ", "ูุนู ูุงุถ", "ูุงุนู", "ููุนูู ุจู"],
         "explanation": "ุงููุฏุฑุณุฉู: ุงุณู ูุฌุฑูุฑ ุจู'ุฅูู' ูุนูุงูุฉ ุฌุฑู ุงููุณุฑุฉ",
         "hint": "ุงูุงุณู ุจุนุฏ ุญุฑู ุงูุฌุฑ ูููู ูุฌุฑูุฑุงู"},
        {"id": 5, "type": "identify_elements", "points": 12,
         "question": "ุญุฏุฏ ููุน ุงููููุฉ ุงูููููุฉ: <ุงูุทุงูุจู> ูุฌุชูุฏ",
         "sentence": "ุงูุทุงูุจู ูุฌุชูุฏ", "correct": 0,
         "elements": ["ูุจุชุฏุฃ", "ุฎุจุฑ", "ูุงุนู", "ููุนูู ุจู"],
         "explanation": "ุงูุทุงูุจู: ูุจุชุฏุฃ ูุฑููุน ุจุงูุถูุฉ, ูุฌุชูุฏ: ุฎุจุฑ ูุฑููุน ุจุงูุถูุฉ",
         "hint": "ุงููุจุชุฏุฃ ูู ุงูุฐู ูุจุฏุฃ ุจู ุงูุฌููุฉ ุงูุงุณููุฉ"},
        {"id": 6, "type": "multiple_choice", "points": 10,
         "question": "ูุง ุฅุนุฑุงุจ 'ุงููุชุงุจู' ูู: 'ุงููุชุงุจู ูููุฏู'ุ",
         "sentence": "ุงููุชุงุจู ูููุฏู", "correct": 0,
         "options": ["ูุจุชุฏุฃ ูุฑููุน", "ุฎุจุฑ ูุฑููุน", "ูุงุนู ูุฑููุน", "ุงุณู ูุฌุฑูุฑ"],
         "explanation": "ุงููุชุงุจู: ูุจุชุฏุฃ ูุฑููุน ุจุงูุถูุฉุ ูููุฏู: ุฎุจุฑ ูุฑููุน ุจุงูุถูุฉ",
         "hint": "ุงูุฌููุฉ ุงูุงุณููุฉ ุชุจุฏุฃ ุจูุจุชุฏุฃ"},
        {"id": 7, "type": "correct_sentence", "points": 15,
         "question": "ุตุญุญ ุงูุฌููุฉ: 'ุงูุทุงูุจุงู ูุฌุชูุฏูู'",
         "sentence": "ุงูุทุงูุจุงู ูุฌุชูุฏูู", "correct_answer": "ุงูุทุงูุจุงู ูุฌุชูุฏุงู",
         "explanation": "ุงูุตุญูุญ: ุงูุทุงูุจุงู ูุฌุชูุฏุงู - ูุฃู ุงููุซูู ูุฑูุน ุจุงูุฃูู",
         "hint": "ุงููุซูู ูุฑูุน ุจุงูุฃูู ูููุตุจ ููุฌุฑ ุจุงููุงุก"},
        {"id": 8, "type": "multiple_choice", "points": 10,
         "question": "ูุง ุถููุฑ ุงููุชููู ูู: 'ุฃูุง ุทุงูุจู'ุ",
         "sentence": "ุฃูุง ุทุงูุจู", "correct": 0,
         "options": ["ุฃูุง", "ุทุงูุจู", "ุถููุฑ ูุณุชุชุฑ", "ูุง ููุฌุฏ"],
         "explanation": "ุฃูุง: ุถููุฑ ุฑูุน ูููุตู ูู ูุญู ุฑูุน ูุจุชุฏุฃ",
         "hint": "ุงูุถูุงุฆุฑ ุฃููุงุน: ูููุตูุฉ ููุชุตูุฉ"},
        {"id": 9, "type": "identify_elements", "points": 12,
         "question": "ูุง ุฅุนุฑุงุจ 'ุงูุชูููุฐุงุชู' ูู: 'ุญุถุฑุช ุงูุชูููุฐุงุชู'ุ",
         "sentence": "ุญุถุฑุช ุงูุชูููุฐุงุชู", "correct": 0,
         "elements": ["ูุงุนู ูุฑููุน", "ููุนูู ุจู ููุตูุจ", "ุฎุจุฑ ูุฑููุน", "ุงุณู ูุฌุฑูุฑ"],
         "explanation": "ุงูุชูููุฐุงุชู: ูุงุนู ูุฑููุน ุจุงูุถูุฉ ูุฃูู ุฌูุน ูุคูุซ ุณุงูู",
         "hint": "ุงููุงุนู ูุฑูุน ุจุนุฏ ุงููุนู"},
        {"id": 10, "type": "multiple_choice", "points": 12,
         "question": "ูุง ููุน 'ูุง' ูู: 'ูุง ุชุฃููู ุจุณุฑุนุฉ'ุ",
         "sentence": "ูุง ุชุฃููู ุจุณุฑุนุฉ", "correct": 0,
         "options": ["ูุงููุฉ", "ูุงููุฉ", "ุนุงุทูุฉ", "ุงุณุชููุงููุฉ"],
         "explanation": "ูุง: ุญุฑู ููู ูุฌุฒูุ ูุงููุนู ุจุนุฏูุง ูุฌุฒูู",
         "hint": "ูุง ุงููุงููุฉ ุชุทูุจ ุงููู ุนู ุงููุนู"},
        {"id": 11, "type": "correct_sentence", "points": 15,
         "question": "ุตุญุญ ุงูุฌููุฉ: ุฑุฌุนูุง ุงููุณุงูุฑูู",
         "sentence": "ุฑุฌุนูุง ุงููุณุงูุฑูู", "correct_answer": "ุฑุฌุน ุงููุณุงูุฑูู",
         "explanation": "ุงูุตุญูุญ: ุฑุฌุน ุงููุณุงูุฑูู - ูุฃู ุงููุนู ูุทุงุจู ุงููุงุนู ูู ุงูุนุฏุฏ",
         "hint": "ุงููุนู ูุทุงุจู ุงููุงุนู ุชุฐููุฑุงู ูุชุฃููุซุงู"},
        {"id": 12, "type": "multiple_choice", "points": 12,
         "question": "ูุง ุฅุนุฑุงุจ 'ูุญููุฏู' ูู: 'ูุญููุฏู ุฎููู'ุ",
         "sentence": "ูุญููุฏู ุฎููู", "correct": 0,
         "options": ["ูุจุชุฏุฃ ูุฑููุน", "ุฎุจุฑ ูุฑููุน", "ูุงุนู ูุฑููุน", "ุตูุฉ ูุฑููุนุฉ"],
         "explanation": "ูุญููุฏู: ูุจุชุฏุฃ ูุฑููุน ุจุงูุถูุฉุ ุฎููู: ูุจุชุฏุฃ ุซุงู ูุฑููุน",
         "hint": "ุงูุฌููุฉ ุงูุงุณููุฉ ูุฏ ุชุชุนุฏุฏ ููููุงุชูุง"},
        {"id": 13, "type": "identify_elements", "points": 10,
         "question": "ุญุฏุฏ ุงููุนู ูู: 'ุงูุทูุงุจ ูุฏุฑุณูู ุจุฌุฏ'",
         "sentence": "ุงูุทูุงุจ ูุฏุฑุณูู ุจุฌุฏ", "correct": 0,
         "elements": ["ูุฏุฑุณูู", "ุงูุทูุงุจ", "ุจุฌุฏ", "ูุฌุชูุฏูู"],
         "explanation": "ูุฏุฑุณูู: ูุนู ูุถุงุฑุน ูุฑููุน ุจุซุจูุช ุงูููู",
         "hint": "ุงููุนู ูู ุงููููุฉ ุงูุชู ุชุฏู ุนูู ุญุฏุซ"},
        {"id": 14, "type": "multiple_choice", "points": 10,
         "question": "ูุง ููุน ุงูุฌููุฉ: 'ุงูุฌูู ุฌูููู'ุ",
         "sentence": "ุงูุฌูู ุฌูููู", "correct": 0,
         "options": ["ุงุณููุฉ", "ูุนููุฉ", "ุดุจู ุฌููุฉ", "ุธุฑููุฉ"],
         "explanation": "ุฌููุฉ ุงุณููุฉ ูุฃููุง ุชุจุฏุฃ ุจุงุณู (ุงููุจุชุฏุฃ)",
         "hint": "ุงูุฌููุฉ ุงูุงุณููุฉ ุชุจุฏุฃ ุจุงุณู"},
        {"id": 15, "type": "correct_sentence", "points": 15,
         "question": "ุตุญุญ ุงูุฌููุฉ: ูุฐุง ุงููุชุจ ูููุฏุฉ",
         "sentence": "ูุฐุง ุงููุชุจ ูููุฏุฉ", "correct_answer": "ูุฐู ุงููุชุจ ูููุฏุฉ",
         "explanation": "ุงูุตุญูุญ: ูุฐู ุงููุชุจ ูููุฏุฉ - ูุฃู 'ูุฐู' ููุฌูุน",
         "hint": "ุฃุณูุงุก ุงูุฅุดุงุฑุฉ ุชุฎุชูู ุญุณุจ ุงูุนุฏุฏ"},
    ],
    2: [
        {"id": 16, "type": "multiple_choice", "points": 15,
         "question": "ูุง ุฅุนุฑุงุจ 'ูุงู' ูู ุงูุฌููุฉ: 'ูุงู ุงูุฌูู ุฌูููุงู'ุ",
         "sentence": "ูุงู ุงูุฌูู ุฌูููุงู", "correct": 0,
         "options": ["ูุนู ูุงุถ ูุงูุต", "ูุนู ูุงุถ ุชุงู", "ุงุณู", "ุญุฑู"],
         "explanation": "ูุงู: ูุนู ูุงุถ ูุงูุต ูุฑูุน ุงููุจุชุฏุฃ ูููุตุจ ุงูุฎุจุฑ",
         "hint": "ูุงู ูุฃุฎูุงุชูุง ุฃูุนุงู ูุงูุตุฉ"},
        {"id": 17, "type": "multiple_choice", "points": 15,
         "question": "ูุง ุฎุจุฑ 'ุฅู' ูู: 'ุฅู ุงูุนููู ูุงูุนู'ุ",
         "sentence": "ุฅู ุงูุนููู ูุงูุนู", "correct": 1,
         "options": ["ุงูุนููู", "ูุงูุนู", "ุฅู", "ูููุฏ"],
         "explanation": "ูุงูุนู: ุฎุจุฑ ุฅู ูุฑููุน ุจุงูุถูุฉ, ุงูุนููู: ุงุณู ุฅู ููุตูุจ ุจุงููุชุญุฉ",
         "hint": "ุฅู ูุฃุฎูุงุชูุง ุชูุตุจ ุงููุจุชุฏุฃ ูุชุฑูุน ุงูุฎุจุฑ"},
        {"id": 18, "type": "identify_elements", "points": 18,
         "question": "ุญุฏุฏ ุฃููุงุน ูุงู ูุฃุฎูุงุชูุง ูู ุงูุฌูู ุงูุชุงููุฉ",
         "sentence": "ูุงู ุงูุทุงูุจ ูุฌุชูุฏุงู - ุตุงุฑ ุงูุฌู ุจุงุฑุฏุงู - ุฃุตุจุญุช ููุฐุจุฉ", "correct": 0,
         "elements": ["ูุงู ูุงูุตุฉ", "ุตุงุฑ ุชุงูุฉ", "ุฃุตุจุญ ูุงูุตุฉ", "ูุงู ุชุงูุฉ"],
         "explanation": "ูููุง ุฃูุนุงู ูุงูุตุฉ: ูุงูุ ุตุงุฑุ ุฃุตุจุญ",
         "hint": "ุฃุฎูุงุช ูุงู: ุตุงุฑุ ุฃุตุจุญุ ุฃูุณูุ ุธูุ ุจุงุชุ ููุณ"},
        {"id": 19, "type": "correct_sentence", "points": 18,
         "question": "ุตุญุญ ุงูุฌููุฉ: 'ุฅู ุงูุทูุงุจ ูุฌุชูุฏูู'",
         "sentence": "ุฅู ุงูุทูุงุจ ูุฌุชูุฏูู", "correct_answer": "ุฅู ุงูุทูุงุจ ูุฌุชูุฏูู",
         "explanation": "ุงูุฌููุฉ ุตุญูุญุฉ: ุฅู ุญุฑู ูุตุจุ ุงูุทูุงุจ ุงุณู ุฅู ููุตูุจุ ูุฌุชูุฏูู ุฎุจุฑ ุฅู ูุฑููุน",
         "hint": "ุฅู ุชูุตุจ ุงููุจุชุฏุฃ ูุชุฑูุน ุงูุฎุจุฑ"},
        {"id": 20, "type": "multiple_choice", "points": 15,
         "question": "ูุง ุฅุนุฑุงุจ 'ูุฃู' ูู: 'ูุฃู ุงููุฌูู ุงููุงุณ'ุ",
         "sentence": "ูุฃู ุงููุฌูู ุงููุงุณ", "correct": 1,
         "options": ["ูุนู ูุงุถ ูุงูุต", "ุญุฑู ุชุดุจูู", "ุงุณู", "ูุนู ุฃูุฑ"],
         "explanation": "ูุฃู: ุญุฑู ุชุดุจูู ููุตุจ",
         "hint": "ุฃุญุฑู ุงูุชุดุจูู: ูุฃูุ ูุฃููุงุ ููุงุ ูุซู"},
        {"id": 21, "type": "identify_elements", "points": 18,
         "question": "ุญุฏุฏ ุงูููุนูู ุงููุทูู ูู ุงูุฌููุฉ",
         "sentence": "ุถุญู ุงูุทูู ุถุญูุงู ุทูููุงู", "correct": 0,
         "elements": ["ุถุญูุงู", "ุงูุทูู", "ุทูููุงู", "ุถุญู"],
         "explanation": "ุถุญูุงู: ููุนูู ูุทูู ููุตูุจ ุจุงููุชุญุฉ",
         "hint": "ุงูููุนูู ุงููุทูู ูุคูุฏ ุงููุนู ุฃู ูุจูู ููุนู"},
        {"id": 22, "type": "multiple_choice", "points": 18,
         "question": "ูุง ููุน ุงูููุนูู ูู: 'ุณุงุฑ ุงูุฌูุฏู ุณูุฑุงู ุณุฑูุนุงู'ุ",
         "sentence": "ุณุงุฑ ุงูุฌูุฏู ุณูุฑุงู ุณุฑูุนุงู", "correct": 0,
         "options": ["ููุนูู ูุทูู", "ููุนูู ุจู", "ููุนูู ูุฃุฌูู", "ููุนูู ูุนู"],
         "explanation": "ุณูุฑุงู: ููุนูู ูุทูู ููุตูุจ ุจุงููุชุญุฉ ูุชุฃููุฏ ุงููุนู",
         "hint": "ุงูููุนูู ุงููุทูู ูุคูุฏ ุงููุนู ุฃู ูุจูู ููุนู ุฃู ุนุฏุฏู"},
        {"id": 23, "type": "correct_sentence", "points": 18,
         "question": "ุตุญุญ ุงูุฌููุฉ: ุณุงุนุฏุช ุงูุงุฎูู ุจุนุถูู",
         "sentence": "ุณุงุนุฏุช ุงูุงุฎูู ุจุนุถูู", "correct_answer": "ุณุงุนุฏ ุงูุฅุฎูุฉ ุจุนุถูู",
         "explanation": "ุงูุตุญูุญ: ุณุงุนุฏ ุงูุฅุฎูุฉ ุจุนุถูู - ุงููุนู ูุทุงุจู ุงููุงุนู",
         "hint": "ุฌูุน ุงูุชูุณูุฑ ูุนุงูู ูุนุงููุฉ ุงูููุฑุฏ"},
        {"id": 24, "type": "multiple_choice", "points": 16,
         "question": "ูุง ุฅุนุฑุงุจ 'ุฃู' ูู: 'ุฃูู ูู ุงููุณู'ุ",
         "sentence": "ุฃูู ูู ุงููุณู", "correct": 0,
         "options": ["ุงุณู ูุนู ูุถุงุฑุน", "ุงุณู ูุนู ูุงุถ", "ุญุฑู", "ูุนู ุฃูุฑ"],
         "explanation": "ุฃูู: ุงุณู ูุนู ูุถุงุฑุน ุจูุนูู (ุฃุชุถุฌุฑ)",
         "hint": "ุฃุณูุงุก ุงูุฃูุนุงู: ุฃูุ ููุงุ ุตูุ ุฅูู"},
        {"id": 25, "type": "identify_elements", "points": 18,
         "question": "ุญุฏุฏ ุงูููุนูู ูุฃุฌูู ูู ุงูุฌููุฉ",
         "sentence": "ุงุฌุชูุฏ ุทูุจุงู ูููุฌุงุญ", "correct": 0,
         "elements": ["ุทูุจุงู", "ุงุฌุชูุฏ", "ูููุฌุงุญ", "ุงููุฌุงุญ"],
         "explanation": "ุทูุจุงู: ููุนูู ูุฃุฌูู ููุตูุจ ุจุงููุชุญุฉ",
         "hint": "ุงูููุนูู ูุฃุฌูู ูุจูู ุณุจุจ ุงููุนู"},
    ],
    3: [
        {"id": 31, "type": "multiple_choice", "points": 20,
         "question": "ูุง ููุน ุงูุฃุณููุจ ูู: 'ูุงูููู ูุฃุฌุชูุฏููู'ุ",
         "sentence": "ูุงูููู ูุฃุฌุชูุฏููู", "correct": 0,
         "options": ["ูุณู", "ุชุนุฌุจ", "ูุฏุญ", "ูุฏุงุก"],
         "explanation": "ุฃุณููุจ ูุณู: ุงููุณู ุจุงููุงูุ ูุงููุงู ูุงู ุงูุชูููุฏุ ูุงูููู ููู ุงูุชูููุฏ",
         "hint": "ุฃุฏูุงุช ุงููุณู: ุงููุงูุ ุงูุจุงุกุ ุงูุชุงุก"},
        {"id": 32, "type": "identify_elements", "points": 22,
         "question": "ุญุฏุฏ ููุน 'ูุง' ูู: 'ูุง ุฃุฌููู ุงูุฑุจูุนู'",
         "sentence": "ูุง ุฃุฌููู ุงูุฑุจูุนู", "correct": 0,
         "elements": ["ุชุนุฌุจูุฉ", "ูุงููุฉ", "ููุตููุฉ", "ุงุณุชููุงููุฉ"],
         "explanation": "ูุง: ุชุนุฌุจูุฉุ ูุฃุฌููู: ูุนู ูุงุถู ุฌุงุก ุนูู ุตูุบุฉ ุงูุชุนุฌุจ",
         "hint": "ุตูุบ ุงูุชุนุฌุจ: ูุง ุฃูุนูููุ ูุฃูุนูู ุจู"},
        {"id": 33, "type": "correct_sentence", "points": 22,
         "question": "ุตุญุญ ุงูุฌููุฉ: 'ูุง ุฑุฌู ุฃูุจู'",
         "sentence": "ูุง ุฑุฌู ุฃูุจู", "correct_answer": "ูุง ุฑุฌูู ุฃูุจู",
         "explanation": "ุงูุตุญูุญ: ูุง ุฑุฌูู ุฃูุจู - ุงูููุงุฏู ุงูููุฑุฏ ุงูุนูู ูุฑููุน",
         "hint": "ุงูููุงุฏู ุงูููุฑุฏ ุงูุนูู ูุจูู ุนูู ุงูุถู"},
        {"id": 34, "type": "multiple_choice", "points": 20,
         "question": "ูุง ุฅุนุฑุงุจ 'ุงูุฐู' ูู: 'ุฌุงุก ุงูุฐู ุงุฌุชูุฏ'ุ",
         "sentence": "ุฌุงุก ุงูุฐู ุงุฌุชูุฏ", "correct": 0,
         "options": ["ุงุณู ููุตูู", "ุงุณู ุฅุดุงุฑุฉ", "ุถููุฑ", "ุงุณู ุงุณุชููุงู"],
         "explanation": "ุงูุฐู: ุงุณู ููุตูู ูุจูู ุนูู ุงูุณููู ูู ูุญู ุฑูุน ูุงุนู",
         "hint": "ุงูุฃุณูุงุก ุงูููุตููุฉ: ุงูุฐูุ ุงูุชูุ ุงููุฐุงูุ ุงููุชุงูุ ุงูุฐููุ ุงูููุงุชู"},
        {"id": 35, "type": "identify_elements", "points": 22,
         "question": "ุญุฏุฏ ุงูุญุงู ูู ุงูุฌููุฉ",
         "sentence": "ุฌุงุก ุงูููุฏ ุฑุงูุถุงู", "correct": 0,
         "elements": ["ุฑุงูุถุงู", "ุฌุงุก", "ุงูููุฏ", "ุฑุงูุถ"],
         "explanation": "ุฑุงูุถุงู: ุญุงู ููุตูุจ ุจุงููุชุญุฉ",
         "hint": "ุงูุญุงู ูุจูู ููุฆุฉ ุตุงุญุจูุง"},
    ]
}

LEADERBOARD = [
    {"name": "ุนุจุฏุงูุนุฒูุฒ", "score": 150, "level": 3},
    {"name": "ุณูู", "score": 120, "level": 2},
    {"name": "ูุญูุฏ", "score": 90, "level": 2},
    {"name": "ุณุงูู", "score": 60, "level": 1},
]

# โโโ Session Helpers โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

def init_session():
    if 'score' not in session:
        session['score'] = 0
    if 'lives' not in session:
        session['lives'] = 3
    if 'current_level' not in session:
        session['current_level'] = 1
    if 'current_question' not in session:
        session['current_question'] = 0
    if 'levels_unlocked' not in session:
        session['levels_unlocked'] = 1
    if 'feedback' not in session:
        session['feedback'] = None

def get_feedback_and_clear():
    fb = session.get('feedback')
    session['feedback'] = None
    return fb

# โโโ Routes โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

@app.route('/')
def index():
    init_session()
    feedback = get_feedback_and_clear()
    return render_template('index.html',
                           score=session['score'],
                           lives=session['lives'],
                           levels_unlocked=session['levels_unlocked'],
                           feedback=feedback)

@app.route('/levels')
def levels():
    init_session()
    return render_template('levels.html',
                           levels_unlocked=session['levels_unlocked'],
                           score=session['score'],
                           lives=session['lives'])

@app.route('/start_level/<int:level>')
def start_level(level):
    if level > session.get('levels_unlocked', 1):
        return redirect(url_for('levels'))
    session['current_level'] = level
    session['current_question'] = 0
    session['lives'] = 3
    return redirect(url_for('question'))

@app.route('/question')
def question():
    init_session()
    level = session['current_level']
    q_idx = session['current_question']
    level_qs = QUESTIONS.get(level, [])

    if q_idx >= len(level_qs):
        return redirect(url_for('level_complete'))

    q = level_qs[q_idx]
    feedback = get_feedback_and_clear()
    return render_template('question.html',
                           question=q,
                           q_num=q_idx + 1,
                           total=len(level_qs),
                           score=session['score'],
                           lives=session['lives'],
                           level=level,
                           feedback=feedback)

@app.route('/answer', methods=['POST'])
def answer():
    level = session.get('current_level', 1)
    q_idx = session.get('current_question', 0)
    level_qs = QUESTIONS.get(level, [])

    if q_idx >= len(level_qs):
        return redirect(url_for('level_complete'))

    q = level_qs[q_idx]
    correct = False

    if q['type'] == 'multiple_choice':
        chosen = request.form.get('option', '-1')
        correct = (int(chosen) == q['correct'])

    elif q['type'] == 'correct_sentence':
        user_ans = request.form.get('correction', '').strip()
        correct = (user_ans.lower() == q['correct_answer'].lower())

    elif q['type'] == 'identify_elements':
        chosen = request.form.get('element', '')
        correct_ans = q['elements'][q['correct']]
        correct = (chosen == correct_ans)

    if correct:
        session['score'] = session.get('score', 0) + q['points']
        session['feedback'] = {
            'type': 'correct',
            'message': f"๐ ุฃุญุณูุช! +{q['points']} ููุทุฉ",
            'explanation': q['explanation']
        }
        session['current_question'] = q_idx + 1
    else:
        session['lives'] = session.get('lives', 3) - 1
        session['feedback'] = {
            'type': 'wrong',
            'message': 'โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ! ููุจ ูุงุญุฏ ููููุฏ',
            'explanation': q['explanation']
        }
        if session['lives'] <= 0:
            return redirect(url_for('game_over'))
        session['current_question'] = q_idx + 1

    return redirect(url_for('question'))

@app.route('/level_complete')
def level_complete():
    level = session.get('current_level', 1)
    score = session.get('score', 0)

    if level >= session.get('levels_unlocked', 1):
        session['levels_unlocked'] = min(level + 1, 3)

    return render_template('level_complete.html',
                           level=level,
                           score=score,
                           has_next=(level < 3))

@app.route('/game_over')
def game_over():
    score = session.get('score', 0)
    session['score'] = 0
    session['lives'] = 3
    session['current_question'] = 0
    return render_template('game_over.html', score=score)

@app.route('/leaderboard')
def leaderboard():
    init_session()
    leaders = sorted(LEADERBOARD + [{"name": "ุฃูุช", "score": session['score'], "level": session['current_level']}],
                     key=lambda x: x['score'], reverse=True)
    return render_template('leaderboard.html', leaders=leaders, score=session['score'])

@app.route('/space')
def space():
    return render_template('space.html',
                           correct_sentences=json.dumps(CORRECT_SENTENCES, ensure_ascii=False),
                           incorrect_sentences=json.dumps(INCORRECT_SENTENCES, ensure_ascii=False))

@app.route('/reset')
def reset():
    session.clear()
    return redirect(url_for('index'))

@app.route('/cheat/<int:level>')
def cheat(level):
    if level in (2, 3):
        current = session.get('levels_unlocked', 1)
        session['levels_unlocked'] = max(current, level)
        return jsonify({'ok': True})
    if level == 0:
        session.clear()
        return jsonify({'ok': True})
    return jsonify({'ok': False})

if __name__ == '__main__':
    app.run()
